import sys
import json
import boto3
from boto3.dynamodb.conditions import Key
import logging
# import pickle, requests, base64
# from urllib import parse

logger = logging.getLogger() # cloudwatchì—ì„œ ë¡œê·¸ ë³´ê¸°
logger.setLevel(logging.INFO)



# connect DynamoDB
try:
    dynamodb = boto3.resource('dynamodb', region_name='ap-northeast-2', endpoint_url='http://dynamodb.ap-northeast-2.amazonaws.com')
    # dynamodb = boto3.client('dynamodb')
except:
    logging.error('could not connect to dynamodb')
    sys.exit(1)
    

# SimpleText ë©”ì‹œì§€
def simple_text(msg):
    return {
        "simpleText": {
            "text": msg
        }
    }

# ì±—ë´‡ ë©”ì‹œì§€
def message(outputs):
    return {
        "version": "2.0",
        "template": {
            "outputs": 
                outputs
                
        }
    }

# ìµœì¢… json response
def json_result(result):
    return {
        'statusCode': 200,
        'body': json.dumps(result),
        'headers': {
            'Access-Control-Allow-Origin': '*',
        }
    }
    
def lambda_handler(event, context):
    
    request_body = json.loads(event['body'])
    logger.info(request_body)
    params = request_body['action']['params']
    input = params['schedule_name']
    
    name = input
     # ë©”ì‹œì§€ ê²°ê³¼ ì €ì¥
    temp = []
    
    if name == "ì¼ì •" :
        info_text = "ê¶ê¸ˆí•œ ì¼ì •ì„ ê²€ìƒ‰í•˜ì„¸ìš”!"
    else :
        table = dynamodb.Table('chat_schedule2')
        response = table.query(
            KeyConditionExpression=Key('content').eq(name)
            )
        
            
        # items = response['Items'][0]
        
        year = response['Items'][0]['year']
        month = response['Items'][0]['month']
        day = response['Items'][0]['day']
        
       
        info_text = "ğŸ“† {} ì¼ì •ì€ \n {}.{}.{} ì…ë‹ˆë‹¤.".format(name, year, month, day)
    
    temp_text = simple_text(info_text)
    # temp_text = simple_text("ì„ íƒí•œ ì¼ì •ì€ {} ì…ë‹ˆë‹¤.".format(input))
    temp.append(temp_text)
    # temp2 = []
    # temp_text2 = {
    #     "year":{}.format(year),
    #     "month":{}.format(month),
    #     "day":{}.format(day)
    # }
    # temp2.append(temp_text2)
    result = message(temp)
        
    return json_result(result)
